steps:
  # Build backend
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/backend-service', './backend']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/backend-service']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run', 'deploy', 'backend-service',
        '--image', 'gcr.io/$PROJECT_ID/backend-service',
        '--region', 'asia-south1',
        '--platform', 'managed',
        '--allow-unauthenticated',
        '--port', '5000',
        '--memory', '1Gi',
        '--cpu', '1',
        '--min-instances', '0',
        '--max-instances', '10',
        '--timeout', '300',
        '--set-env-vars', 'NODE_ENV=production,TZ=Asia/Kolkata,DB_NAME=aitf-db,DB_USER=auth_admin,JWT_EXPIRES_IN=24h,EMAIL_HOST=smtp.gmail.com,EMAIL_PORT=587,EMAIL_USER=harshitmangtani002@gmail.com,EMAIL_FROM=AITF System <harshitmangtani002@gmail.com>,GOOGLE_CLOUD_PROJECT_ID=aitf-474614,GOOGLE_CLOUD_BUCKET_NAME=aitf-internship,GOOGLE_SHEET_ID=1HBbyE3F_8OYG3q_d4ubxU22_P6LSz-ZGShUFgVy5uA4,GOOGLE_DRIVE_FOLDER_ID=0AFFcPXsmbiTcUk9PVA,SERVICE_ACCOUNT_EMAIL=service-acc1@aitf-474614.iam.gserviceaccount.com,CALENDAR_DOMAIN=aitf-team-c.com,SLACK_TEAM_ID=T09KZ3DFLTF,SLACK_WORKSPACE_INVITE_URL=https://join.slack.com/t/aitfrecruitme-9cj4395/shared_invite/zt-3fq1hwhu9-W5E99QPvxnDFKcXlM37pvQ,GOOGLE_IMPERSONATE_EMAIL=harshit.mangtani@aitf-team-c.com,RECRUITING_CALENDAR_ID=primary,FRONTEND_URL=https://frontend-service-1015265749887.asia-south1.run.app',
        '--add-cloudsql-instances', 'aitf-474614:asia-south1:aitf-team-c',
        '--set-secrets', 'DB_PASSWORD=db-password:latest,JWT_SECRET=jwt-secret:latest,EMAIL_PASS=email-password:latest,GEMINI_API_KEY=gemini-api-key:latest,GOOGLE_SHEETS_API_KEY=google-sheets-api-key:latest,SLACK_BOT_TOKEN=slack-bot-token:latest,SLACK_SIGNING_SECRET=slack-signing-secret:latest',
        '--set-secrets', '/secrets/key.json=gcp-service-key:latest'
      ]

  # Build and deploy frontend
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-t', 'gcr.io/$PROJECT_ID/frontend-service',
      '--build-arg', 'NEXT_PUBLIC_API_URL=https://backend-service-1015265749887.asia-south1.run.app/api',
      './frontend'
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/frontend-service']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run', 'deploy', 'frontend-service',
        '--image', 'gcr.io/$PROJECT_ID/frontend-service',
        '--region', 'asia-south1',
        '--platform', 'managed',
        '--allow-unauthenticated',
        '--port', '3000',
        '--memory', '512Mi',
        '--set-env-vars', 'NODE_ENV=production,NEXT_PUBLIC_API_URL=https://backend-service-1015265749887.asia-south1.run.app/api'
      ]

options:
  logging: CLOUD_LOGGING_ONLY

images:
  - 'gcr.io/$PROJECT_ID/backend-service'
  - 'gcr.io/$PROJECT_ID/frontend-service'